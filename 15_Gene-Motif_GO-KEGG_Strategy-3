
# Load required libraries
library(clusterProfiler)
library(org.Mm.eg.db)
library(ggplot2)
library(enrichplot)

setwd("/Volumes/DataBox/ProjMCS7")

# Read your data
data <- read.csv("marker_genes_motifs_detailed_summary.csv")

# Get unique genes per cluster - using base R
genes_by_cluster <- unique(data[, c("Cluster", "Gene")])

# Create a list of gene vectors by cluster
gene_lists <- split(genes_by_cluster$Gene, genes_by_cluster$Cluster)

# Function to convert gene symbols to Entrez IDs
convert_to_entrez <- function(gene_symbols) {
  entrez_ids <- bitr(gene_symbols, 
                     fromType = "SYMBOL",
                     toType = "ENTREZID", 
                     OrgDb = org.Mm.eg.db)
  return(entrez_ids$ENTREZID)
}

# Convert all gene lists to Entrez IDs
gene_lists_entrez <- lapply(gene_lists, convert_to_entrez)

# ===== GO Enrichment Analysis =====

# GO Biological Process
go_bp_results <- list()
for (cluster in names(gene_lists_entrez)) {
  go_bp_results[[cluster]] <- enrichGO(
    gene = gene_lists_entrez[[cluster]],
    OrgDb = org.Mm.eg.db,
    ont = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.2,
    readable = TRUE
  )
}

# GO Molecular Function
go_mf_results <- list()
for (cluster in names(gene_lists_entrez)) {
  go_mf_results[[cluster]] <- enrichGO(
    gene = gene_lists_entrez[[cluster]],
    OrgDb = org.Mm.eg.db,
    ont = "MF",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.2,
    readable = TRUE
  )
}

# GO Cellular Component
go_cc_results <- list()
for (cluster in names(gene_lists_entrez)) {
  go_cc_results[[cluster]] <- enrichGO(
    gene = gene_lists_entrez[[cluster]],
    OrgDb = org.Mm.eg.db,
    ont = "CC",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.2,
    readable = TRUE
  )
}

# ===== KEGG Pathway Analysis =====

kegg_results <- list()
for (cluster in names(gene_lists_entrez)) {
  kegg_results[[cluster]] <- enrichKEGG(
    gene = gene_lists_entrez[[cluster]],
    organism = 'mmu',
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.2
  )
}

# ===== Export Results =====

# Function to export enrichment results
export_results <- function(result_list, prefix) {
  for (cluster in names(result_list)) {
    if (!is.null(result_list[[cluster]]) && nrow(result_list[[cluster]]) > 0) {
      write.csv(as.data.frame(result_list[[cluster]]), 
                file = paste0(prefix, "_", cluster, ".csv"),
                row.names = FALSE)
    }
  }
}

# Export all results
export_results(go_bp_results, "GO_BP")
export_results(go_mf_results, "GO_MF")
export_results(go_cc_results, "GO_CC")
export_results(kegg_results, "KEGG")

# ===== Visualizations =====

# Create output directory for plots
dir.create("enrichment_plots", showWarnings = FALSE)

# Plot GO BP results for each cluster
for (cluster in names(go_bp_results)) {
  if (!is.null(go_bp_results[[cluster]]) && nrow(go_bp_results[[cluster]]) > 0) {
    
    # Dot plot
    p1 <- dotplot(go_bp_results[[cluster]], showCategory=20, 
                  title = paste("GO BP -", cluster))
    ggsave(paste0("enrichment_plots/GO_BP_dotplot_", cluster, ".pdf"), 
           p1, width = 10, height = 8)
    
    # Bar plot
    p2 <- barplot(go_bp_results[[cluster]], showCategory=15,
                  title = paste("GO BP -", cluster))
    ggsave(paste0("enrichment_plots/GO_BP_barplot_", cluster, ".pdf"), 
           p2, width = 10, height = 6)
  }
}

# Plot KEGG results for each cluster
for (cluster in names(kegg_results)) {
  if (!is.null(kegg_results[[cluster]]) && nrow(kegg_results[[cluster]]) > 0) {
    
    p <- dotplot(kegg_results[[cluster]], showCategory=20,
                 title = paste("KEGG Pathways -", cluster))
    ggsave(paste0("enrichment_plots/KEGG_dotplot_", cluster, ".pdf"), 
           p, width = 10, height = 8)
  }
}

# ===== Combined visualization across clusters =====

# Combine GO BP results for comparison
combined_go_bp <- data.frame()
for (cluster in names(go_bp_results)) {
  if (!is.null(go_bp_results[[cluster]]) && nrow(go_bp_results[[cluster]]) > 0) {
    temp <- as.data.frame(go_bp_results[[cluster]])
    temp$Cluster <- cluster
    combined_go_bp <- rbind(combined_go_bp, temp)
  }
}

# Save combined results
write.csv(combined_go_bp, "GO_BP_all_clusters_combined_Strategy3.csv", row.names = FALSE)

# ===== Summary Statistics =====

# Create summary of enrichment results
summary_stats <- data.frame(
  Cluster = names(gene_lists),
  N_Genes = sapply(gene_lists, length),
  N_GO_BP = sapply(go_bp_results, function(x) if(!is.null(x)) nrow(x) else 0),
  N_GO_MF = sapply(go_mf_results, function(x) if(!is.null(x)) nrow(x) else 0),
  N_GO_CC = sapply(go_cc_results, function(x) if(!is.null(x)) nrow(x) else 0),
  N_KEGG = sapply(kegg_results, function(x) if(!is.null(x)) nrow(x) else 0)
)

write.csv(summary_stats, "enrichment_summary_statistics_Strategy3.csv", row.names = FALSE)
print(summary_stats)

cat("\nEnrichment analysis complete!\n")
